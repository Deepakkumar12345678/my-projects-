/* =========================
   CONFIGURATION (EDIT HERE)
   ========================= */

/* Lock password — change here to update site password.
   This is the single place to change password (edit index.html on GitHub). */
const ADMIN_PASSWORD = "DTYPL5133"; // ← change this value in code to update password

/* Admin messages (code-only): keep array of messages.
   System will pick a message daily (based on date) — daily rotation.
   You can add as many messages as you want. These are read-only in UI. */
const ADMIN_MESSAGES = [
  " लाइफ मे कुछ अच्छा करो यार ",
  "मुझे ऐसा लगता है कि तुम लोगों को लगता है कि मैं किसी बात पर ज़िद कर बैठूँगा — कि मैं कहूँगा कि मुझसे शादी करो या कोई और बात जिस पर मैं अड़ जाऊँ, चाहे कुछ भी हो जाए, चाहे बदनामी ही क्यों न हो जाए।\n\nअरे यार, मेरे पास भी अपना स्वाभिमान है, मुझे अपनी इज़्ज़त की भी चिंता होती है — कि क्या करने से मेरी इज़्ज़त घटेगी, क्या करने से मुझे बदनामी होगी।\n\nतुम कौन होते हो मेरी जाति पर या मेरे फैसलों पर सवाल उठाने वाले?\n\nमुझे अपनी जाति का भी मान है, और मैं कोई भागने वाला या शादी से डरने वाला इंसान नहीं हूँ।\n\nलेकिन अगर कोई मुझे जलाएगा, तड़पाएगा, उलझाकर रखेगा, मेरी भावनाओं का मज़ाक बनाएगा —\n\nतो मुझे दिक्कत तो होगी ही।\n\nइसके लिए तो मैं लड़ूँगा ही, गुस्सा भी आएगा — मेरे पास भी दिल-दिमाग है, और मुझे पता है कि क्या सही है और क्या ग़लत।\n\nतुम अगर सही से बोलोगे, मार्गदर्शन दोगे, बात को महत्व दोगे —\n\nतो मैं समझूँगा।\n\nवरना मुझे लगता है कि कोई मुझे जान-बूझकर जला रहा है, और मेरी बात की कोई value ही नहीं है।\n\nअगर तुम धोखा देने की सोच भी रखोगे,\n\nतो फिर तुम्हें मेरे अंदर वही मिलेगा, जैसा इरादा तुम मेरे लिए रखोगे।\n\nऔर कुछ कहने की ज़रूरत नहीं।",
  "मधुर शब्द बाँटो, प्यार पाओ।",
  "छोटे छोटे कदम बड़े बदलाव लाते हैं।",
  "आज एक मुस्कान किसी का दिन बना सकती है — मुस्कुराओ! ❤️",
  "सिकंदर बनो पर दिल नरम रखो।",
  "हर दिन एक नया मौका है — कुछ अच्छा करें।"
];

/* Optional: custom date-specific overrides (YYYY-MM-DD -> message index)
   If you want a specific message for a date, add here:
   "2025-12-25": 3   // will pick ADMIN_MESSAGES[3]
*/
const ADMIN_DATE_OVERRIDES = {
  // "2025-12-25": 4
};

/* =========================
   Helpers: TTS, toast, explain
   ========================= */
let isSpeaking = false;
let currentUtterance = null;

function speak(text, rate = 0.8, pitch = 1.0, volume = 1.0) {
  if (!('speechSynthesis' in window)) {
    console.warn("Speech synthesis not supported");
    return;
  }
  
  try {
    // Stop any ongoing speech
    if (isSpeaking) {
      speechSynthesis.cancel();
    }
    
    const utterance = new SpeechSynthesisUtterance(String(text));
    currentUtterance = utterance;
    
    // Get available voices
    const voices = speechSynthesis.getVoices();
    
    // Try to find a Hindi voice first, then English, then any voice
    let voice = voices.find(v => /hi|hindi/i.test(v.lang)) || 
                voices.find(v => /en/i.test(v.lang)) || 
                voices[0];
    
    if (voice) {
      utterance.voice = voice;
      utterance.lang = voice.lang;
    } else {
      utterance.lang = 'hi-IN';
    }
    
    // Set speech parameters
    utterance.rate = rate; // Slower speed for clarity
    utterance.pitch = pitch;
    utterance.volume = volume;
    
    // Event handlers
    utterance.onstart = function() {
      isSpeaking = true;
    };
    
    utterance.onend = function() {
      isSpeaking = false;
      currentUtterance = null;
    };
    
    utterance.onerror = function(event) {
      console.error("Speech synthesis error:", event);
      isSpeaking = false;
      currentUtterance = null;
    };
    
    // Speak the text
    speechSynthesis.speak(utterance);
    
  } catch (error) {
    console.error("Error in speak function:", error);
    isSpeaking = false;
    currentUtterance = null;
  }
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.opacity = '1';
  
  // Clear any existing timeout
  if (t._timeout) {
    clearTimeout(t._timeout);
  }
  
  // Hide toast after 3 seconds
  t._timeout = setTimeout(() => {
    t.style.opacity = '0';
  }, 3000);
}

/* Tap-to-explain: data-explain attribute */
document.addEventListener('click', function(event) {
  const element = event.target.closest('[data-explain]');
  if (element) {
    const text = element.getAttribute('data-explain');
    if (text) {
      speak(text);
      showToast(text);
    }
  }
});

/* =========================
   Lock behavior
   ========================= */
const lockCard = document.getElementById('lockCard');
const unlockInput = document.getElementById('unlockInput');
const unlockBtn = document.getElementById('unlockBtn');
const mainGrid = document.getElementById('mainGrid');

unlockBtn.addEventListener('click', function() {
  attemptUnlock(unlockInput.value.trim());
});

// Enter key support for password input
unlockInput.addEventListener('keypress', function(event) {
  if (event.key === 'Enter') {
    attemptUnlock(unlockInput.value.trim());
  }
});

function attemptUnlock(password) {
  if (!password) {
    speak("कृपया पासवर्ड भरें", 0.7);
    showToast("Password required");
    unlockInput.focus();
    return;
  }
  
  if (password === ADMIN_PASSWORD) {
    speak("स्वागत है, साइट खुल रही है। यह साइट विशेष लोगों के लिए है, आप यहाँ तक पहुँच गए हैं, आपका दिल से स्वागत है! सबसे पहले आपको एडमिन का संदेश मिलेगा, फिर आप मुझसे चैट कर सकते हैं। मैं हर सवाल का जवाब तो नहीं दे पाऊँगी, लेकिन आपके संदेश को एडमिन तक पहुँचाकर सही उत्तर दिलवा सकती हूँ।", 0.7);
    
    // Hide lock card and show main grid
    lockCard.style.display = 'none';
    mainGrid.style.display = 'block';
    
    // Show today's admin message
    displayDailyAdmin();
    
  } else {
    speak("गलत पासवर्ड, कृपया पुनः प्रयास करें", 0.7);
    showToast("Wrong password");
    unlockInput.value = '';
    unlockInput.focus();
    
    // Shake animation for wrong password
    lockCard.animate([
      { transform: 'translateX(-6px)' },
      { transform: 'translateX(6px)' },
      { transform: 'translateX(0)' }
    ], { duration: 380 });
  }
}

/* =========================
   Admin daily message logic (code-only)
   ========================= */
function getDailyAdminIndex() {
  const today = new Date();
  const year = today.getFullYear();
  const month = (today.getMonth() + 1).toString().padStart(2, '0');
  const day = today.getDate().toString().padStart(2, '0');
  const dateKey = `${year}-${month}-${day}`;
  
  // Check for override
  if (ADMIN_DATE_OVERRIDES[dateKey] !== undefined) {
    return ADMIN_DATE_OVERRIDES[dateKey] % ADMIN_MESSAGES.length;
  }
  
  // Deterministic rotation based on date
  const numeric = Number(`${year}${month}${day}`);
  return numeric % ADMIN_MESSAGES.length;
}

function displayDailyAdmin() {
  const index = getDailyAdminIndex();
  const message = ADMIN_MESSAGES[index] || "कोई संदेश उपलब्ध नहीं।";
  const messageElement = document.getElementById('adminMessage');
  const timeElement = document.getElementById('adminTime');
  
  // Replace \n with <br> for HTML display
  const formattedMessage = message.replace(/\n/g, '<br>');
  messageElement.innerHTML = formattedMessage;
  
  // Format current date and time
  const now = new Date();
  const options = { 
    day: 'numeric', 
    month: 'long', 
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  };
  timeElement.textContent = now.toLocaleString('hi-IN', options);
  
  // Speak admin message after a delay
  setTimeout(() => {
    speak("Admin संदेश: " + message, 0.7);
  }, 1500);
}

/* =========================
   Minimize toggles
   ========================= */
document.querySelectorAll('.minBtn').forEach(button => {
  button.addEventListener('click', function() {
    const panelType = this.getAttribute('data-toggle'); // admin, user, or media
    const panel = document.getElementById(panelType + 'Panel');
    
    if (panel.classList.contains('minimized')) {
      panel.classList.remove('minimized');
      this.textContent = '–';
    } else {
      panel.classList.add('minimized');
      this.textContent = '+';
    }
  });
});

/* =========================
   Chat: user messages (localStorage)
   ========================= */
const chatWindow = document.getElementById('chatWindow');
const userInput = document.getElementById('userInput');
const sendUser = document.getElementById('sendUser');
const savedArea = document.getElementById('savedArea');

function getUserMessages() {
  try {
    const messages = localStorage.getItem('priyanka_user_v2');
    return messages ? JSON.parse(messages) : [];
  } catch (error) {
    console.error("Error reading messages from localStorage:", error);
    return [];
  }
}

function saveUserMessages(messages) {
  try {
    localStorage.setItem('priyanka_user_v2', JSON.stringify(messages));
  } catch (error) {
    console.error("Error saving messages to localStorage:", error);
  }
}

function renderSavedMessages() {
  const messages = getUserMessages();
  
  if (messages.length === 0) {
    savedArea.innerHTML = "<div class='muted'>No saved messages.</div>";
    return;
  }
  
  const messagesHtml = messages.map(message => `
    <div style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px;">
      <div style="font-size:14px">${escapeHtml(message.text)}</div>
      <div class="muted">${message.time}</div>
    </div>
  `).join('');
  
  savedArea.innerHTML = messagesHtml;
}

function addChatMessage(sender, text) {
  const messageRow = document.createElement('div');
  messageRow.className = 'chatRow ' + (sender === 'user' ? 'user' : 'assistant');
  
  const bubble = document.createElement('div');
  bubble.className = 'bubble ' + (sender === 'user' ? 'user' : 'assistant');
  bubble.textContent = text;
  
  messageRow.appendChild(bubble);
  chatWindow.appendChild(messageRow);
  
  // Scroll to the bottom
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function assistantReply(userText) {
  const text = userText.toLowerCase();
  
  if (text.includes('hello') || text.includes('hi') || text.includes('namaste')) {
    return "हैलो! मैं आपकी कैसे मदद करूँ? ❤️";
  }
  
  if (text.includes('pyar') || text.includes('love') || text.includes('❤️') || text.includes('pyaar')) {
    return "आप बेहद खास हो — मैं हमेशा साथ हूँ ❤️";
  }
  
  if (text.includes('photo') || text.includes('picture') || text.includes('image')) {
    return "Media में photo URL डालकर Show photo दबाएँ।";
  }
  
  if (text.includes('video') || text.includes('movie') || text.includes('film')) {
    return "Media में video URL डालकर Play video दबाएँ।";
  }
  
  if (text.includes('thanks') || text.includes('thank you') || text.includes('dhanyavad') || text.includes('shukriya')) {
    return "आपका स्वागत है! हमेशा आपकी सेवा में ❤️";
  }
  
  if (text.includes('help') || text.includes('madad') || text.includes('sahayata')) {
    return "मैं आपकी कैसे मदद कर सकती हूँ? आप अपनी बात मुझे बताएं, मैं एडमिन तक पहुँचाने में मदद करूँगी।";
  }
  
  return "मैंने आपकी बात सुनी: \"" + userText + "\" — बताइए और क्या चाहिए?";
}

sendUser.addEventListener('click', function() {
  const message = userInput.value.trim();
  
  if (!message) {
    speak("कृपया संदेश लिखें", 0.7);
    showToast("Enter a message");
    userInput.focus();
    return;
  }
  
  // Add user message to chat
  addChatMessage('user', message);
  
  // Save message
  const messages = getUserMessages();
  const now = new Date();
  const timeString = now.toLocaleString('hi-IN', {
    day: 'numeric',
    month: 'short',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
  
  messages.push({
    text: message,
    time: timeString
  });
  
  saveUserMessages(messages);
  renderSavedMessages();
  
  // Get and display assistant reply
  const reply = assistantReply(message);
  
  setTimeout(() => {
    addChatMessage('assistant', reply);
    speak(reply, 0.7);
  }, 600);
  
  // Clear input and refocus
  userInput.value = '';
  userInput.focus();
});

// Enter key support for chat (but allow Shift+Enter for new line)
userInput.addEventListener('keypress', function(event) {
  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    sendUser.click();
  }
});

// Clear chat button
document.getElementById('clearChatBtn').addEventListener('click', function() {
  chatWindow.innerHTML = '';
  speak("Chat साफ़ हो गया", 0.7);
  showToast("Chat cleared");
});

// Download messages button
document.getElementById('downloadUser').addEventListener('click', function() {
  const messages = getUserMessages();
  const data = JSON.stringify(messages, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  
  const link = document.createElement('a');
  link.href = url;
  link.download = 'user-messages.json';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  URL.revokeObjectURL(url);
  
  speak("Saved messages डाउनलोड हो रहे हैं", 0.7);
  showToast("Messages downloaded");
});

// Show saved messages button
document.getElementById('showSavedBtn').addEventListener('click', function() {
  renderSavedMessages();
  speak("Saved messages दिखाए जा रहे हैं", 0.7);
  showToast("Saved messages shown");
});

// Initial render of saved messages
renderSavedMessages();

/* =========================
   Media loading
   ========================= */
const mediaPreview = document.getElementById('mediaPreview');

document.getElementById('loadMediaBtn').addEventListener('click', function() {
  const url = document.getElementById('mediaUrl').value.trim();
  
  if (!url) {
    speak("कृपया media url डालें", 0.7);
    showToast("Enter URL");
    return;
  }
  
  loadMedia(url);
});

function loadMedia(url) {
  // YouTube video
  if (url.includes('youtube.com') || url.includes('youtu.be')) {
    let videoId = '';
    
    if (url.includes('youtu.be/')) {
      videoId = url.split('youtu.be/')[1].split(/[?&]/)[0];
    } else if (url.includes('v=')) {
      videoId = url.split('v=')[1].split('&')[0];
    }
    
    if (videoId) {
      mediaPreview.innerHTML = `
        <iframe 
          width="100%" 
          height="260" 
          src="https://www.youtube.com/embed/${videoId}" 
          frameborder="0" 
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
          allowfullscreen>
        </iframe>
      `;
      speak("YouTube video लोड हो गया", 0.7);
      showToast("YouTube loaded");
      return;
    }
  }
  
  // Video files
  if (/\.mp4|\.webm|\.ogg/i.test(url)) {
    mediaPreview.innerHTML = `
      <video controls style="width:100%;max-height:320px;">
        <source src="${url}" type="video/mp4">
        Your browser does not support the video tag.
      </video>
    `;
    speak("Video लोड हो गया", 0.7);
    showToast("Video loaded");
    return;
  }
  
  // Audio files
  if (/\.mp3|\.wav|\.m4a|\.ogg|audio/i.test(url)) {
    mediaPreview.innerHTML = `
      <audio controls style="width:100%;">
        <source src="${url}" type="audio/mpeg">
        Your browser does not support the audio element.
      </audio>
    `;
    speak("Audio लोड हो गया", 0.7);
    showToast("Audio loaded");
    return;
  }
  
  // Image files
  if (/\.jpg|\.jpeg|\.png|\.gif|\.svg|\.webp/i.test(url)) {
    mediaPreview.innerHTML = `
      <img 
        src="${url}" 
        alt="Loaded media" 
        style="width:100%;height:auto;display:block;max-height:320px;border-radius:8px;"
        onerror="this.onerror=null;this.parentElement.innerHTML='<div class=\\'muted\\'>Failed to load image</div>';"
      >
    `;
    speak("Image लोड हो गया", 0.7);
    showToast("Image loaded");
    return;
  }
  
  // Default fallback
  mediaPreview.innerHTML = `
    <div style="padding:12px;text-align:center;">
      Preview not supported for this URL.<br>
      <a href="${url}" target="_blank" style="color:var(--accent3);text-decoration:none;">Open link in new tab</a>
    </div>
  `;
  speak("Link लोड हो गया, लेकिन preview उपलब्ध नहीं है", 0.7);
  showToast("Link loaded (no preview)");
}

// Media control buttons
document.getElementById('playAudioBtn').addEventListener('click', function() {
  const audio = mediaPreview.querySelector('audio');
  if (audio) {
    audio.play();
    speak("Audio चल रहा है", 0.7);
    showToast("Audio playing");
  } else {
    speak("No audio loaded to play", 0.7);
    showToast("No audio to play");
  }
});

document.getElementById('playVideoBtn').addEventListener('click', function() {
  const video = mediaPreview.querySelector('video');
  if (video) {
    video.play();
    speak("Video चल रहा है", 0.7);
    showToast("Video playing");
  } else {
    speak("No video loaded to play", 0.7);
    showToast("No video to play");
  }
});

document.getElementById('showPhotoBtn').addEventListener('click', function() {
  const image = mediaPreview.querySelector('img');
  if (image) {
    speak("Photo preview दिख रहा है", 0.7);
    showToast("Photo preview");
  } else {
    speak("No image loaded to show", 0.7);
    showToast("No image to show");
  }
});

/* Voice guide */
document.getElementById('voiceGuide').addEventListener('click', function() {
  const guide = "यह Priyanka assistant है। सबसे पहले लॉक खुलना चाहिए। Admin Message readonly है और हर दिन का संदेश दिखेगा। User Chat में message भेजें और ❤ दबाएँ। Media box में URL डालकर Load करें।";
  speak(guide, 0.7);
  showToast("Guide चलाया गया");
});

/* =========================
   Initialize the application
   ========================= */
document.addEventListener('DOMContentLoaded', function() {
  // Auto-focus on password input
  unlockInput.focus();
  
  // Initialize TTS voices if available
  if ('speechSynthesis' in window) {
    // Load voices
    setTimeout(function() {
      const voices = speechSynthesis.getVoices();
      if (voices.length > 0) {
        console.log("TTS voices loaded:", voices.length);
      }
    }, 500);
    
    // Some browsers need this to properly load voices
    speechSynthesis.getVoices();
  }
  
  // Welcome message (silent)
  console.log("Priyanka Assistant loaded. Please enter password to unlock.");
});/* =========================
   CONFIGURATION (EDIT HERE)
   ========================= */

/* Lock password — change here to update site password.
   This is the single place to change password (edit index.html on GitHub). */
const ADMIN_PASSWORD = "DTYPL5133"; // ← change this value in code to update password

/* Admin messages (code-only): keep array of messages.
   System will pick a message daily (based on date) — daily rotation.
   You can add as many messages as you want. These are read-only in UI. */
const ADMIN_MESSAGES = [
  " लाइफ मे कुछ अच्छा करो यार ",
  "मुझे ऐसा लगता है कि तुम लोगों को लगता है कि मैं किसी बात पर ज़िद कर बैठूँगा — कि मैं कहूँगा कि मुझसे शादी करो या कोई और बात जिस पर मैं अड़ जाऊँ, चाहे कुछ भी हो जाए, चाहे बदनामी ही क्यों न हो जाए।\n\nअरे यार, मेरे पास भी अपना स्वाभिमान है, मुझे अपनी इज़्ज़त की भी चिंता होती है — कि क्या करने से मेरी इज़्ज़त घटेगी, क्या करने से मुझे बदनामी होगी।\n\nतुम कौन होते हो मेरी जाति पर या मेरे फैसलों पर सवाल उठाने वाले?\n\nमुझे अपनी जाति का भी मान है, और मैं कोई भागने वाला या शादी से डरने वाला इंसान नहीं हूँ।\n\nलेकिन अगर कोई मुझे जलाएगा, तड़पाएगा, उलझाकर रखेगा, मेरी भावनाओं का मज़ाक बनाएगा —\n\nतो मुझे दिक्कत तो होगी ही।\n\nइसके लिए तो मैं लड़ूँगा ही, गुस्सा भी आएगा — मेरे पास भी दिल-दिमाग है, और मुझे पता है कि क्या सही है और क्या ग़लत।\n\nतुम अगर सही से बोलोगे, मार्गदर्शन दोगे, बात को महत्व दोगे —\n\nतो मैं समझूँगा।\n\nवरना मुझे लगता है कि कोई मुझे जान-बूझकर जला रहा है, और मेरी बात की कोई value ही नहीं है।\n\nअगर तुम धोखा देने की सोच भी रखोगे,\n\nतो फिर तुम्हें मेरे अंदर वही मिलेगा, जैसा इरादा तुम मेरे लिए रखोगे।\n\nऔर कुछ कहने की ज़रूरत नहीं।",
  "मधुर शब्द बाँटो, प्यार पाओ।",
  "छोटे छोटे कदम बड़े बदलाव लाते हैं।",
  "आज एक मुस्कान किसी का दिन बना सकती है — मुस्कुराओ! ❤️",
  "सिकंदर बनो पर दिल नरम रखो।",
  "हर दिन एक नया मौका है — कुछ अच्छा करें।"
];

/* Optional: custom date-specific overrides (YYYY-MM-DD -> message index)
   If you want a specific message for a date, add here:
   "2025-12-25": 3   // will pick ADMIN_MESSAGES[3]
*/
const ADMIN_DATE_OVERRIDES = {
  // "2025-12-25": 4
};

/* =========================
   Helpers: TTS, toast, explain
   ========================= */
let isSpeaking = false;
let currentUtterance = null;

function speak(text, rate = 0.8, pitch = 1.0, volume = 1.0) {
  if (!('speechSynthesis' in window)) {
    console.warn("Speech synthesis not supported");
    return;
  }
  
  try {
    // Stop any ongoing speech
    if (isSpeaking) {
      speechSynthesis.cancel();
    }
    
    const utterance = new SpeechSynthesisUtterance(String(text));
    currentUtterance = utterance;
    
    // Get available voices
    const voices = speechSynthesis.getVoices();
    
    // Try to find a Hindi voice first, then English, then any voice
    let voice = voices.find(v => /hi|hindi/i.test(v.lang)) || 
                voices.find(v => /en/i.test(v.lang)) || 
                voices[0];
    
    if (voice) {
      utterance.voice = voice;
      utterance.lang = voice.lang;
    } else {
      utterance.lang = 'hi-IN';
    }
    
    // Set speech parameters
    utterance.rate = rate; // Slower speed for clarity
    utterance.pitch = pitch;
    utterance.volume = volume;
    
    // Event handlers
    utterance.onstart = function() {
      isSpeaking = true;
    };
    
    utterance.onend = function() {
      isSpeaking = false;
      currentUtterance = null;
    };
    
    utterance.onerror = function(event) {
      console.error("Speech synthesis error:", event);
      isSpeaking = false;
      currentUtterance = null;
    };
    
    // Speak the text
    speechSynthesis.speak(utterance);
    
  } catch (error) {
    console.error("Error in speak function:", error);
    isSpeaking = false;
    currentUtterance = null;
  }
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.opacity = '1';
  
  // Clear any existing timeout
  if (t._timeout) {
    clearTimeout(t._timeout);
  }
  
  // Hide toast after 3 seconds
  t._timeout = setTimeout(() => {
    t.style.opacity = '0';
  }, 3000);
}

/* Tap-to-explain: data-explain attribute */
document.addEventListener('click', function(event) {
  const element = event.target.closest('[data-explain]');
  if (element) {
    const text = element.getAttribute('data-explain');
    if (text) {
      speak(text);
      showToast(text);
    }
  }
});

/* =========================
   Lock behavior
   ========================= */
const lockCard = document.getElementById('lockCard');
const unlockInput = document.getElementById('unlockInput');
const unlockBtn = document.getElementById('unlockBtn');
const mainGrid = document.getElementById('mainGrid');

unlockBtn.addEventListener('click', function() {
  attemptUnlock(unlockInput.value.trim());
});

// Enter key support for password input
unlockInput.addEventListener('keypress', function(event) {
  if (event.key === 'Enter') {
    attemptUnlock(unlockInput.value.trim());
  }
});

function attemptUnlock(password) {
  if (!password) {
    speak("कृपया पासवर्ड भरें", 0.7);
    showToast("Password required");
    unlockInput.focus();
    return;
  }
  
  if (password === ADMIN_PASSWORD) {
    speak("स्वागत है, साइट खुल रही है। यह साइट विशेष लोगों के लिए है, आप यहाँ तक पहुँच गए हैं, आपका दिल से स्वागत है! सबसे पहले आपको एडमिन का संदेश मिलेगा, फिर आप मुझसे चैट कर सकते हैं। मैं हर सवाल का जवाब तो नहीं दे पाऊँगी, लेकिन आपके संदेश को एडमिन तक पहुँचाकर सही उत्तर दिलवा सकती हूँ।", 0.7);
    
    // Hide lock card and show main grid
    lockCard.style.display = 'none';
    mainGrid.style.display = 'block';
    
    // Show today's admin message
    displayDailyAdmin();
    
  } else {
    speak("गलत पासवर्ड, कृपया पुनः प्रयास करें", 0.7);
    showToast("Wrong password");
    unlockInput.value = '';
    unlockInput.focus();
    
    // Shake animation for wrong password
    lockCard.animate([
      { transform: 'translateX(-6px)' },
      { transform: 'translateX(6px)' },
      { transform: 'translateX(0)' }
    ], { duration: 380 });
  }
}

/* =========================
   Admin daily message logic (code-only)
   ========================= */
function getDailyAdminIndex() {
  const today = new Date();
  const year = today.getFullYear();
  const month = (today.getMonth() + 1).toString().padStart(2, '0');
  const day = today.getDate().toString().padStart(2, '0');
  const dateKey = `${year}-${month}-${day}`;
  
  // Check for override
  if (ADMIN_DATE_OVERRIDES[dateKey] !== undefined) {
    return ADMIN_DATE_OVERRIDES[dateKey] % ADMIN_MESSAGES.length;
  }
  
  // Deterministic rotation based on date
  const numeric = Number(`${year}${month}${day}`);
  return numeric % ADMIN_MESSAGES.length;
}

function displayDailyAdmin() {
  const index = getDailyAdminIndex();
  const message = ADMIN_MESSAGES[index] || "कोई संदेश उपलब्ध नहीं।";
  const messageElement = document.getElementById('adminMessage');
  const timeElement = document.getElementById('adminTime');
  
  // Replace \n with <br> for HTML display
  const formattedMessage = message.replace(/\n/g, '<br>');
  messageElement.innerHTML = formattedMessage;
  
  // Format current date and time
  const now = new Date();
  const options = { 
    day: 'numeric', 
    month: 'long', 
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  };
  timeElement.textContent = now.toLocaleString('hi-IN', options);
  
  // Speak admin message after a delay
  setTimeout(() => {
    speak("Admin संदेश: " + message, 0.7);
  }, 1500);
}

/* =========================
   Minimize toggles
   ========================= */
document.querySelectorAll('.minBtn').forEach(button => {
  button.addEventListener('click', function() {
    const panelType = this.getAttribute('data-toggle'); // admin, user, or media
    const panel = document.getElementById(panelType + 'Panel');
    
    if (panel.classList.contains('minimized')) {
      panel.classList.remove('minimized');
      this.textContent = '–';
    } else {
      panel.classList.add('minimized');
      this.textContent = '+';
    }
  });
});

/* =========================
   Chat: user messages (localStorage)
   ========================= */
const chatWindow = document.getElementById('chatWindow');
const userInput = document.getElementById('userInput');
const sendUser = document.getElementById('sendUser');
const savedArea = document.getElementById('savedArea');

function getUserMessages() {
  try {
    const messages = localStorage.getItem('priyanka_user_v2');
    return messages ? JSON.parse(messages) : [];
  } catch (error) {
    console.error("Error reading messages from localStorage:", error);
    return [];
  }
}

function saveUserMessages(messages) {
  try {
    localStorage.setItem('priyanka_user_v2', JSON.stringify(messages));
  } catch (error) {
    console.error("Error saving messages to localStorage:", error);
  }
}

function renderSavedMessages() {
  const messages = getUserMessages();
  
  if (messages.length === 0) {
    savedArea.innerHTML = "<div class='muted'>No saved messages.</div>";
    return;
  }
  
  const messagesHtml = messages.map(message => `
    <div style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px;">
      <div style="font-size:14px">${escapeHtml(message.text)}</div>
      <div class="muted">${message.time}</div>
    </div>
  `).join('');
  
  savedArea.innerHTML = messagesHtml;
}

function addChatMessage(sender, text) {
  const messageRow = document.createElement('div');
  messageRow.className = 'chatRow ' + (sender === 'user' ? 'user' : 'assistant');
  
  const bubble = document.createElement('div');
  bubble.className = 'bubble ' + (sender === 'user' ? 'user' : 'assistant');
  bubble.textContent = text;
  
  messageRow.appendChild(bubble);
  chatWindow.appendChild(messageRow);
  
  // Scroll to the bottom
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function assistantReply(userText) {
  const text = userText.toLowerCase();
  
  if (text.includes('hello') || text.includes('hi') || text.includes('namaste')) {
    return "हैलो! मैं आपकी कैसे मदद करूँ? ❤️";
  }
  
  if (text.includes('pyar') || text.includes('love') || text.includes('❤️') || text.includes('pyaar')) {
    return "आप बेहद खास हो — मैं हमेशा साथ हूँ ❤️";
  }
  
  if (text.includes('photo') || text.includes('picture') || text.includes('image')) {
    return "Media में photo URL डालकर Show photo दबाएँ।";
  }
  
  if (text.includes('video') || text.includes('movie') || text.includes('film')) {
    return "Media में video URL डालकर Play video दबाएँ।";
  }
  
  if (text.includes('thanks') || text.includes('thank you') || text.includes('dhanyavad') || text.includes('shukriya')) {
    return "आपका स्वागत है! हमेशा आपकी सेवा में ❤️";
  }
  
  if (text.includes('help') || text.includes('madad') || text.includes('sahayata')) {
    return "मैं आपकी कैसे मदद कर सकती हूँ? आप अपनी बात मुझे बताएं, मैं एडमिन तक पहुँचाने में मदद करूँगी।";
  }
  
  return "मैंने आपकी बात सुनी: \"" + userText + "\" — बताइए और क्या चाहिए?";
}

sendUser.addEventListener('click', function() {
  const message = userInput.value.trim();
  
  if (!message) {
    speak("कृपया संदेश लिखें", 0.7);
    showToast("Enter a message");
    userInput.focus();
    return;
  }
  
  // Add user message to chat
  addChatMessage('user', message);
  
  // Save message
  const messages = getUserMessages();
  const now = new Date();
  const timeString = now.toLocaleString('hi-IN', {
    day: 'numeric',
    month: 'short',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
  
  messages.push({
    text: message,
    time: timeString
  });
  
  saveUserMessages(messages);
  renderSavedMessages();
  
  // Get and display assistant reply
  const reply = assistantReply(message);
  
  setTimeout(() => {
    addChatMessage('assistant', reply);
    speak(reply, 0.7);
  }, 600);
  
  // Clear input and refocus
  userInput.value = '';
  userInput.focus();
});

// Enter key support for chat (but allow Shift+Enter for new line)
userInput.addEventListener('keypress', function(event) {
  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    sendUser.click();
  }
});

// Clear chat button
document.getElementById('clearChatBtn').addEventListener('click', function() {
  chatWindow.innerHTML = '';
  speak("Chat साफ़ हो गया", 0.7);
  showToast("Chat cleared");
});

// Download messages button
document.getElementById('downloadUser').addEventListener('click', function() {
  const messages = getUserMessages();
  const data = JSON.stringify(messages, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  
  const link = document.createElement('a');
  link.href = url;
  link.download = 'user-messages.json';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  URL.revokeObjectURL(url);
  
  speak("Saved messages डाउनलोड हो रहे हैं", 0.7);
  showToast("Messages downloaded");
});

// Show saved messages button
document.getElementById('showSavedBtn').addEventListener('click', function() {
  renderSavedMessages();
  speak("Saved messages दिखाए जा रहे हैं", 0.7);
  showToast("Saved messages shown");
});

// Initial render of saved messages
renderSavedMessages();

/* =========================
   Media loading
   ========================= */
const mediaPreview = document.getElementById('mediaPreview');

document.getElementById('loadMediaBtn').addEventListener('click', function() {
  const url = document.getElementById('mediaUrl').value.trim();
  
  if (!url) {
    speak("कृपया media url डालें", 0.7);
    showToast("Enter URL");
    return;
  }
  
  loadMedia(url);
});

function loadMedia(url) {
  // YouTube video
  if (url.includes('youtube.com') || url.includes('youtu.be')) {
    let videoId = '';
    
    if (url.includes('youtu.be/')) {
      videoId = url.split('youtu.be/')[1].split(/[?&]/)[0];
    } else if (url.includes('v=')) {
      videoId = url.split('v=')[1].split('&')[0];
    }
    
    if (videoId) {
      mediaPreview.innerHTML = `
        <iframe 
          width="100%" 
          height="260" 
          src="https://www.youtube.com/embed/${videoId}" 
          frameborder="0" 
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
          allowfullscreen>
        </iframe>
      `;
      speak("YouTube video लोड हो गया", 0.7);
      showToast("YouTube loaded");
      return;
    }
  }
  
  // Video files
  if (/\.mp4|\.webm|\.ogg/i.test(url)) {
    mediaPreview.innerHTML = `
      <video controls style="width:100%;max-height:320px;">
        <source src="${url}" type="video/mp4">
        Your browser does not support the video tag.
      </video>
    `;
    speak("Video लोड हो गया", 0.7);
    showToast("Video loaded");
    return;
  }
  
  // Audio files
  if (/\.mp3|\.wav|\.m4a|\.ogg|audio/i.test(url)) {
    mediaPreview.innerHTML = `
      <audio controls style="width:100%;">
        <source src="${url}" type="audio/mpeg">
        Your browser does not support the audio element.
      </audio>
    `;
    speak("Audio लोड हो गया", 0.7);
    showToast("Audio loaded");
    return;
  }
  
  // Image files
  if (/\.jpg|\.jpeg|\.png|\.gif|\.svg|\.webp/i.test(url)) {
    mediaPreview.innerHTML = `
      <img 
        src="${url}" 
        alt="Loaded media" 
        style="width:100%;height:auto;display:block;max-height:320px;border-radius:8px;"
        onerror="this.onerror=null;this.parentElement.innerHTML='<div class=\\'muted\\'>Failed to load image</div>';"
      >
    `;
    speak("Image लोड हो गया", 0.7);
    showToast("Image loaded");
    return;
  }
  
  // Default fallback
  mediaPreview.innerHTML = `
    <div style="padding:12px;text-align:center;">
      Preview not supported for this URL.<br>
      <a href="${url}" target="_blank" style="color:var(--accent3);text-decoration:none;">Open link in new tab</a>
    </div>
  `;
  speak("Link लोड हो गया, लेकिन preview उपलब्ध नहीं है", 0.7);
  showToast("Link loaded (no preview)");
}

// Media control buttons
document.getElementById('playAudioBtn').addEventListener('click', function() {
  const audio = mediaPreview.querySelector('audio');
  if (audio) {
    audio.play();
    speak("Audio चल रहा है", 0.7);
    showToast("Audio playing");
  } else {
    speak("No audio loaded to play", 0.7);
    showToast("No audio to play");
  }
});

document.getElementById('playVideoBtn').addEventListener('click', function() {
  const video = mediaPreview.querySelector('video');
  if (video) {
    video.play();
    speak("Video चल रहा है", 0.7);
    showToast("Video playing");
  } else {
    speak("No video loaded to play", 0.7);
    showToast("No video to play");
  }
});

document.getElementById('showPhotoBtn').addEventListener('click', function() {
  const image = mediaPreview.querySelector('img');
  if (image) {
    speak("Photo preview दिख रहा है", 0.7);
    showToast("Photo preview");
  } else {
    speak("No image loaded to show", 0.7);
    showToast("No image to show");
  }
});

/* Voice guide */
document.getElementById('voiceGuide').addEventListener('click', function() {
  const guide = "यह Priyanka assistant है। सबसे पहले लॉक खुलना चाहिए। Admin Message readonly है और हर दिन का संदेश दिखेगा। User Chat में message भेजें और ❤ दबाएँ। Media box में URL डालकर Load करें।";
  speak(guide, 0.7);
  showToast("Guide चलाया गया");
});

/* =========================
   Initialize the application
   ========================= */
document.addEventListener('DOMContentLoaded', function() {
  // Auto-focus on password input
  unlockInput.focus();
  
  // Initialize TTS voices if available
  if ('speechSynthesis' in window) {
    // Load voices
    setTimeout(function() {
      const voices = speechSynthesis.getVoices();
      if (voices.length > 0) {
        console.log("TTS voices loaded:", voices.length);
      }
    }, 500);
    
    // Some browsers need this to properly load voices
    speechSynthesis.getVoices();
  }
  
  // Welcome message (silent)
  console.log("Priyanka Assistant loaded. Please enter password to unlock.");
});/* =========================
   CONFIGURATION (EDIT HERE)
   ========================= */

/* Lock password — change here to update site password.
   This is the single place to change password (edit index.html on GitHub). */
const ADMIN_PASSWORD = "DTYPL5133"; // ← change this value in code to update password

/* Admin messages (code-only): keep array of messages.
   System will pick a message daily (based on date) — daily rotation.
   You can add as many messages as you want. These are read-only in UI. */
const ADMIN_MESSAGES = [
  " लाइफ मे कुछ अच्छा करो यार ",
  "मुझे ऐसा लगता है कि तुम लोगों को लगता है कि मैं किसी बात पर ज़िद कर बैठूँगा — कि मैं कहूँगा कि मुझसे शादी करो या कोई और बात जिस पर मैं अड़ जाऊँ, चाहे कुछ भी हो जाए, चाहे बदनामी ही क्यों न हो जाए।\n\nअरे यार, मेरे पास भी अपना स्वाभिमान है, मुझे अपनी इज़्ज़त की भी चिंता होती है — कि क्या करने से मेरी इज़्ज़त घटेगी, क्या करने से मुझे बदनामी होगी।\n\nतुम कौन होते हो मेरी जाति पर या मेरे फैसलों पर सवाल उठाने वाले?\n\nमुझे अपनी जाति का भी मान है, और मैं कोई भागने वाला या शादी से डरने वाला इंसान नहीं हूँ।\n\nलेकिन अगर कोई मुझे जलाएगा, तड़पाएगा, उलझाकर रखेगा, मेरी भावनाओं का मज़ाक बनाएगा —\n\nतो मुझे दिक्कत तो होगी ही।\n\nइसके लिए तो मैं लड़ूँगा ही, गुस्सा भी आएगा — मेरे पास भी दिल-दिमाग है, और मुझे पता है कि क्या सही है और क्या ग़लत।\n\nतुम अगर सही से बोलोगे, मार्गदर्शन दोगे, बात को महत्व दोगे —\n\nतो मैं समझूँगा।\n\nवरना मुझे लगता है कि कोई मुझे जान-बूझकर जला रहा है, और मेरी बात की कोई value ही नहीं है।\n\nअगर तुम धोखा देने की सोच भी रखोगे,\n\nतो फिर तुम्हें मेरे अंदर वही मिलेगा, जैसा इरादा तुम मेरे लिए रखोगे।\n\nऔर कुछ कहने की ज़रूरत नहीं।",
  "मधुर शब्द बाँटो, प्यार पाओ।",
  "छोटे छोटे कदम बड़े बदलाव लाते हैं।",
  "आज एक मुस्कान किसी का दिन बना सकती है — मुस्कुराओ! ❤️",
  "सिकंदर बनो पर दिल नरम रखो।",
  "हर दिन एक नया मौका है — कुछ अच्छा करें।"
];

/* Optional: custom date-specific overrides (YYYY-MM-DD -> message index)
   If you want a specific message for a date, add here:
   "2025-12-25": 3   // will pick ADMIN_MESSAGES[3]
*/
const ADMIN_DATE_OVERRIDES = {
  // "2025-12-25": 4
};

/* =========================
   Helpers: TTS, toast, explain
   ========================= */
let isSpeaking = false;
let currentUtterance = null;

function speak(text, rate = 0.8, pitch = 1.0, volume = 1.0) {
  if (!('speechSynthesis' in window)) {
    console.warn("Speech synthesis not supported");
    return;
  }
  
  try {
    // Stop any ongoing speech
    if (isSpeaking) {
      speechSynthesis.cancel();
    }
    
    const utterance = new SpeechSynthesisUtterance(String(text));
    currentUtterance = utterance;
    
    // Get available voices
    const voices = speechSynthesis.getVoices();
    
    // Try to find a Hindi voice first, then English, then any voice
    let voice = voices.find(v => /hi|hindi/i.test(v.lang)) || 
                voices.find(v => /en/i.test(v.lang)) || 
                voices[0];
    
    if (voice) {
      utterance.voice = voice;
      utterance.lang = voice.lang;
    } else {
      utterance.lang = 'hi-IN';
    }
    
    // Set speech parameters
    utterance.rate = rate; // Slower speed for clarity
    utterance.pitch = pitch;
    utterance.volume = volume;
    
    // Event handlers
    utterance.onstart = function() {
      isSpeaking = true;
    };
    
    utterance.onend = function() {
      isSpeaking = false;
      currentUtterance = null;
    };
    
    utterance.onerror = function(event) {
      console.error("Speech synthesis error:", event);
      isSpeaking = false;
      currentUtterance = null;
    };
    
    // Speak the text
    speechSynthesis.speak(utterance);
    
  } catch (error) {
    console.error("Error in speak function:", error);
    isSpeaking = false;
    currentUtterance = null;
  }
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.opacity = '1';
  
  // Clear any existing timeout
  if (t._timeout) {
    clearTimeout(t._timeout);
  }
  
  // Hide toast after 3 seconds
  t._timeout = setTimeout(() => {
    t.style.opacity = '0';
  }, 3000);
}

/* Tap-to-explain: data-explain attribute */
document.addEventListener('click', function(event) {
  const element = event.target.closest('[data-explain]');
  if (element) {
    const text = element.getAttribute('data-explain');
    if (text) {
      speak(text);
      showToast(text);
    }
  }
});

/* =========================
   Lock behavior
   ========================= */
const lockCard = document.getElementById('lockCard');
const unlockInput = document.getElementById('unlockInput');
const unlockBtn = document.getElementById('unlockBtn');
const mainGrid = document.getElementById('mainGrid');

unlockBtn.addEventListener('click', function() {
  attemptUnlock(unlockInput.value.trim());
});

// Enter key support for password input
unlockInput.addEventListener('keypress', function(event) {
  if (event.key === 'Enter') {
    attemptUnlock(unlockInput.value.trim());
  }
});

function attemptUnlock(password) {
  if (!password) {
    speak("कृपया पासवर्ड भरें", 0.7);
    showToast("Password required");
    unlockInput.focus();
    return;
  }
  
  if (password === ADMIN_PASSWORD) {
    speak("स्वागत है, साइट खुल रही है। यह साइट विशेष लोगों के लिए है, आप यहाँ तक पहुँच गए हैं, आपका दिल से स्वागत है! सबसे पहले आपको एडमिन का संदेश मिलेगा, फिर आप मुझसे चैट कर सकते हैं। मैं हर सवाल का जवाब तो नहीं दे पाऊँगी, लेकिन आपके संदेश को एडमिन तक पहुँचाकर सही उत्तर दिलवा सकती हूँ।", 0.7);
    
    // Hide lock card and show main grid
    lockCard.style.display = 'none';
    mainGrid.style.display = 'block';
    
    // Show today's admin message
    displayDailyAdmin();
    
  } else {
    speak("गलत पासवर्ड, कृपया पुनः प्रयास करें", 0.7);
    showToast("Wrong password");
    unlockInput.value = '';
    unlockInput.focus();
    
    // Shake animation for wrong password
    lockCard.animate([
      { transform: 'translateX(-6px)' },
      { transform: 'translateX(6px)' },
      { transform: 'translateX(0)' }
    ], { duration: 380 });
  }
}

/* =========================
   Admin daily message logic (code-only)
   ========================= */
function getDailyAdminIndex() {
  const today = new Date();
  const year = today.getFullYear();
  const month = (today.getMonth() + 1).toString().padStart(2, '0');
  const day = today.getDate().toString().padStart(2, '0');
  const dateKey = `${year}-${month}-${day}`;
  
  // Check for override
  if (ADMIN_DATE_OVERRIDES[dateKey] !== undefined) {
    return ADMIN_DATE_OVERRIDES[dateKey] % ADMIN_MESSAGES.length;
  }
  
  // Deterministic rotation based on date
  const numeric = Number(`${year}${month}${day}`);
  return numeric % ADMIN_MESSAGES.length;
}

function displayDailyAdmin() {
  const index = getDailyAdminIndex();
  const message = ADMIN_MESSAGES[index] || "कोई संदेश उपलब्ध नहीं।";
  const messageElement = document.getElementById('adminMessage');
  const timeElement = document.getElementById('adminTime');
  
  // Replace \n with <br> for HTML display
  const formattedMessage = message.replace(/\n/g, '<br>');
  messageElement.innerHTML = formattedMessage;
  
  // Format current date and time
  const now = new Date();
  const options = { 
    day: 'numeric', 
    month: 'long', 
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  };
  timeElement.textContent = now.toLocaleString('hi-IN', options);
  
  // Speak admin message after a delay
  setTimeout(() => {
    speak("Admin संदेश: " + message, 0.7);
  }, 1500);
}

/* =========================
   Minimize toggles
   ========================= */
document.querySelectorAll('.minBtn').forEach(button => {
  button.addEventListener('click', function() {
    const panelType = this.getAttribute('data-toggle'); // admin, user, or media
    const panel = document.getElementById(panelType + 'Panel');
    
    if (panel.classList.contains('minimized')) {
      panel.classList.remove('minimized');
      this.textContent = '–';
    } else {
      panel.classList.add('minimized');
      this.textContent = '+';
    }
  });
});

/* =========================
   Chat: user messages (localStorage)
   ========================= */
const chatWindow = document.getElementById('chatWindow');
const userInput = document.getElementById('userInput');
const sendUser = document.getElementById('sendUser');
const savedArea = document.getElementById('savedArea');

function getUserMessages() {
  try {
    const messages = localStorage.getItem('priyanka_user_v2');
    return messages ? JSON.parse(messages) : [];
  } catch (error) {
    console.error("Error reading messages from localStorage:", error);
    return [];
  }
}

function saveUserMessages(messages) {
  try {
    localStorage.setItem('priyanka_user_v2', JSON.stringify(messages));
  } catch (error) {
    console.error("Error saving messages to localStorage:", error);
  }
}

function renderSavedMessages() {
  const messages = getUserMessages();
  
  if (messages.length === 0) {
    savedArea.innerHTML = "<div class='muted'>No saved messages.</div>";
    return;
  }
  
  const messagesHtml = messages.map(message => `
    <div style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px;">
      <div style="font-size:14px">${escapeHtml(message.text)}</div>
      <div class="muted">${message.time}</div>
    </div>
  `).join('');
  
  savedArea.innerHTML = messagesHtml;
}

function addChatMessage(sender, text) {
  const messageRow = document.createElement('div');
  messageRow.className = 'chatRow ' + (sender === 'user' ? 'user' : 'assistant');
  
  const bubble = document.createElement('div');
  bubble.className = 'bubble ' + (sender === 'user' ? 'user' : 'assistant');
  bubble.textContent = text;
  
  messageRow.appendChild(bubble);
  chatWindow.appendChild(messageRow);
  
  // Scroll to the bottom
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function assistantReply(userText) {
  const text = userText.toLowerCase();
  
  if (text.includes('hello') || text.includes('hi') || text.includes('namaste')) {
    return "हैलो! मैं आपकी कैसे मदद करूँ? ❤️";
  }
  
  if (text.includes('pyar') || text.includes('love') || text.includes('❤️') || text.includes('pyaar')) {
    return "आप बेहद खास हो — मैं हमेशा साथ हूँ ❤️";
  }
  
  if (text.includes('photo') || text.includes('picture') || text.includes('image')) {
    return "Media में photo URL डालकर Show photo दबाएँ।";
  }
  
  if (text.includes('video') || text.includes('movie') || text.includes('film')) {
    return "Media में video URL डालकर Play video दबाएँ।";
  }
  
  if (text.includes('thanks') || text.includes('thank you') || text.includes('dhanyavad') || text.includes('shukriya')) {
    return "आपका स्वागत है! हमेशा आपकी सेवा में ❤️";
  }
  
  if (text.includes('help') || text.includes('madad') || text.includes('sahayata')) {
    return "मैं आपकी कैसे मदद कर सकती हूँ? आप अपनी बात मुझे बताएं, मैं एडमिन तक पहुँचाने में मदद करूँगी।";
  }
  
  return "मैंने आपकी बात सुनी: \"" + userText + "\" — बताइए और क्या चाहिए?";
}

sendUser.addEventListener('click', function() {
  const message = userInput.value.trim();
  
  if (!message) {
    speak("कृपया संदेश लिखें", 0.7);
    showToast("Enter a message");
    userInput.focus();
    return;
  }
  
  // Add user message to chat
  addChatMessage('user', message);
  
  // Save message
  const messages = getUserMessages();
  const now = new Date();
  const timeString = now.toLocaleString('hi-IN', {
    day: 'numeric',
    month: 'short',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
  
  messages.push({
    text: message,
    time: timeString
  });
  
  saveUserMessages(messages);
  renderSavedMessages();
  
  // Get and display assistant reply
  const reply = assistantReply(message);
  
  setTimeout(() => {
    addChatMessage('assistant', reply);
    speak(reply, 0.7);
  }, 600);
  
  // Clear input and refocus
  userInput.value = '';
  userInput.focus();
});

// Enter key support for chat (but allow Shift+Enter for new line)
userInput.addEventListener('keypress', function(event) {
  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    sendUser.click();
  }
});

// Clear chat button
document.getElementById('clearChatBtn').addEventListener('click', function() {
  chatWindow.innerHTML = '';
  speak("Chat साफ़ हो गया", 0.7);
  showToast("Chat cleared");
});

// Download messages button
document.getElementById('downloadUser').addEventListener('click', function() {
  const messages = getUserMessages();
  const data = JSON.stringify(messages, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  
  const link = document.createElement('a');
  link.href = url;
  link.download = 'user-messages.json';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  URL.revokeObjectURL(url);
  
  speak("Saved messages डाउनलोड हो रहे हैं", 0.7);
  showToast("Messages downloaded");
});

// Show saved messages button
document.getElementById('showSavedBtn').addEventListener('click', function() {
  renderSavedMessages();
  speak("Saved messages दिखाए जा रहे हैं", 0.7);
  showToast("Saved messages shown");
});

// Initial render of saved messages
renderSavedMessages();

/* =========================
   Media loading
   ========================= */
const mediaPreview = document.getElementById('mediaPreview');

document.getElementById('loadMediaBtn').addEventListener('click', function() {
  const url = document.getElementById('mediaUrl').value.trim();
  
  if (!url) {
    speak("कृपया media url डालें", 0.7);
    showToast("Enter URL");
    return;
  }
  
  loadMedia(url);
});

function loadMedia(url) {
  // YouTube video
  if (url.includes('youtube.com') || url.includes('youtu.be')) {
    let videoId = '';
    
    if (url.includes('youtu.be/')) {
      videoId = url.split('youtu.be/')[1].split(/[?&]/)[0];
    } else if (url.includes('v=')) {
      videoId = url.split('v=')[1].split('&')[0];
    }
    
    if (videoId) {
      mediaPreview.innerHTML = `
        <iframe 
          width="100%" 
          height="260" 
          src="https://www.youtube.com/embed/${videoId}" 
          frameborder="0" 
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
          allowfullscreen>
        </iframe>
      `;
      speak("YouTube video लोड हो गया", 0.7);
      showToast("YouTube loaded");
      return;
    }
  }
  
  // Video files
  if (/\.mp4|\.webm|\.ogg/i.test(url)) {
    mediaPreview.innerHTML = `
      <video controls style="width:100%;max-height:320px;">
        <source src="${url}" type="video/mp4">
        Your browser does not support the video tag.
      </video>
    `;
    speak("Video लोड हो गया", 0.7);
    showToast("Video loaded");
    return;
  }
  
  // Audio files
  if (/\.mp3|\.wav|\.m4a|\.ogg|audio/i.test(url)) {
    mediaPreview.innerHTML = `
      <audio controls style="width:100%;">
        <source src="${url}" type="audio/mpeg">
        Your browser does not support the audio element.
      </audio>
    `;
    speak("Audio लोड हो गया", 0.7);
    showToast("Audio loaded");
    return;
  }
  
  // Image files
  if (/\.jpg|\.jpeg|\.png|\.gif|\.svg|\.webp/i.test(url)) {
    mediaPreview.innerHTML = `
      <img 
        src="${url}" 
        alt="Loaded media" 
        style="width:100%;height:auto;display:block;max-height:320px;border-radius:8px;"
        onerror="this.onerror=null;this.parentElement.innerHTML='<div class=\\'muted\\'>Failed to load image</div>';"
      >
    `;
    speak("Image लोड हो गया", 0.7);
    showToast("Image loaded");
    return;
  }
  
  // Default fallback
  mediaPreview.innerHTML = `
    <div style="padding:12px;text-align:center;">
      Preview not supported for this URL.<br>
      <a href="${url}" target="_blank" style="color:var(--accent3);text-decoration:none;">Open link in new tab</a>
    </div>
  `;
  speak("Link लोड हो गया, लेकिन preview उपलब्ध नहीं है", 0.7);
  showToast("Link loaded (no preview)");
}

// Media control buttons
document.getElementById('playAudioBtn').addEventListener('click', function() {
  const audio = mediaPreview.querySelector('audio');
  if (audio) {
    audio.play();
    speak("Audio चल रहा है", 0.7);
    showToast("Audio playing");
  } else {
    speak("No audio loaded to play", 0.7);
    showToast("No audio to play");
  }
});

document.getElementById('playVideoBtn').addEventListener('click', function() {
  const video = mediaPreview.querySelector('video');
  if (video) {
    video.play();
    speak("Video चल रहा है", 0.7);
    showToast("Video playing");
  } else {
    speak("No video loaded to play", 0.7);
    showToast("No video to play");
  }
});

document.getElementById('showPhotoBtn').addEventListener('click', function() {
  const image = mediaPreview.querySelector('img');
  if (image) {
    speak("Photo preview दिख रहा है", 0.7);
    showToast("Photo preview");
  } else {
    speak("No image loaded to show", 0.7);
    showToast("No image to show");
  }
});

/* Voice guide */
document.getElementById('voiceGuide').addEventListener('click', function() {
  const guide = "यह Priyanka assistant है। सबसे पहले लॉक खुलना चाहिए। Admin Message readonly है और हर दिन का संदेश दिखेगा। User Chat में message भेजें और ❤ दबाएँ। Media box में URL डालकर Load करें।";
  speak(guide, 0.7);
  showToast("Guide चलाया गया");
});

/* =========================
   Initialize the application
   ========================= */
document.addEventListener('DOMContentLoaded', function() {
  // Auto-focus on password input
  unlockInput.focus();
  
  // Initialize TTS voices if available
  if ('speechSynthesis' in window) {
    // Load voices
    setTimeout(function() {
      const voices = speechSynthesis.getVoices();
      if (voices.length > 0) {
        console.log("TTS voices loaded:", voices.length);
      }
    }, 500);
    
    // Some browsers need this to properly load voices
    speechSynthesis.getVoices();
  }
  
  // Welcome message (silent)
  console.log("Priyanka Assistant loaded. Please enter password to unlock.");
});/* =========================
   CONFIGURATION (EDIT HERE)
   ========================= */

/* Lock password — change here to update site password.
   This is the single place to change password (edit index.html on GitHub). */
const ADMIN_PASSWORD = "DTYPL5133"; // ← change this value in code to update password

/* Admin messages (code-only): keep array of messages.
   System will pick a message daily (based on date) — daily rotation.
   You can add as many messages as you want. These are read-only in UI. */
const ADMIN_MESSAGES = [
  " लाइफ मे कुछ अच्छा करो यार ",
  "मुझे ऐसा लगता है कि तुम लोगों को लगता है कि मैं किसी बात पर ज़िद कर बैठूँगा — कि मैं कहूँगा कि मुझसे शादी करो या कोई और बात जिस पर मैं अड़ जाऊँ, चाहे कुछ भी हो जाए, चाहे बदनामी ही क्यों न हो जाए।\n\nअरे यार, मेरे पास भी अपना स्वाभिमान है, मुझे अपनी इज़्ज़त की भी चिंता होती है — कि क्या करने से मेरी इज़्ज़त घटेगी, क्या करने से मुझे बदनामी होगी।\n\nतुम कौन होते हो मेरी जाति पर या मेरे फैसलों पर सवाल उठाने वाले?\n\nमुझे अपनी जाति का भी मान है, और मैं कोई भागने वाला या शादी से डरने वाला इंसान नहीं हूँ।\n\nलेकिन अगर कोई मुझे जलाएगा, तड़पाएगा, उलझाकर रखेगा, मेरी भावनाओं का मज़ाक बनाएगा —\n\nतो मुझे दिक्कत तो होगी ही।\n\nइसके लिए तो मैं लड़ूँगा ही, गुस्सा भी आएगा — मेरे पास भी दिल-दिमाग है, और मुझे पता है कि क्या सही है और क्या ग़लत।\n\nतुम अगर सही से बोलोगे, मार्गदर्शन दोगे, बात को महत्व दोगे —\n\nतो मैं समझूँगा।\n\nवरना मुझे लगता है कि कोई मुझे जान-बूझकर जला रहा है, और मेरी बात की कोई value ही नहीं है।\n\nअगर तुम धोखा देने की सोच भी रखोगे,\n\nतो फिर तुम्हें मेरे अंदर वही मिलेगा, जैसा इरादा तुम मेरे लिए रखोगे।\n\nऔर कुछ कहने की ज़रूरत नहीं।",
  "मधुर शब्द बाँटो, प्यार पाओ।",
  "छोटे छोटे कदम बड़े बदलाव लाते हैं।",
  "आज एक मुस्कान किसी का दिन बना सकती है — मुस्कुराओ! ❤️",
  "सिकंदर बनो पर दिल नरम रखो।",
  "हर दिन एक नया मौका है — कुछ अच्छा करें।"
];

/* Optional: custom date-specific overrides (YYYY-MM-DD -> message index)
   If you want a specific message for a date, add here:
   "2025-12-25": 3   // will pick ADMIN_MESSAGES[3]
*/
const ADMIN_DATE_OVERRIDES = {
  // "2025-12-25": 4
};

/* =========================
   Helpers: TTS, toast, explain
   ========================= */
let isSpeaking = false;
let currentUtterance = null;

function speak(text, rate = 0.8, pitch = 1.0, volume = 1.0) {
  if (!('speechSynthesis' in window)) {
    console.warn("Speech synthesis not supported");
    return;
  }
  
  try {
    // Stop any ongoing speech
    if (isSpeaking) {
      speechSynthesis.cancel();
    }
    
    const utterance = new SpeechSynthesisUtterance(String(text));
    currentUtterance = utterance;
    
    // Get available voices
    const voices = speechSynthesis.getVoices();
    
    // Try to find a Hindi voice first, then English, then any voice
    let voice = voices.find(v => /hi|hindi/i.test(v.lang)) || 
                voices.find(v => /en/i.test(v.lang)) || 
                voices[0];
    
    if (voice) {
      utterance.voice = voice;
      utterance.lang = voice.lang;
    } else {
      utterance.lang = 'hi-IN';
    }
    
    // Set speech parameters
    utterance.rate = rate; // Slower speed for clarity
    utterance.pitch = pitch;
    utterance.volume = volume;
    
    // Event handlers
    utterance.onstart = function() {
      isSpeaking = true;
    };
    
    utterance.onend = function() {
      isSpeaking = false;
      currentUtterance = null;
    };
    
    utterance.onerror = function(event) {
      console.error("Speech synthesis error:", event);
      isSpeaking = false;
      currentUtterance = null;
    };
    
    // Speak the text
    speechSynthesis.speak(utterance);
    
  } catch (error) {
    console.error("Error in speak function:", error);
    isSpeaking = false;
    currentUtterance = null;
  }
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.opacity = '1';
  
  // Clear any existing timeout
  if (t._timeout) {
    clearTimeout(t._timeout);
  }
  
  // Hide toast after 3 seconds
  t._timeout = setTimeout(() => {
    t.style.opacity = '0';
  }, 3000);
}

/* Tap-to-explain: data-explain attribute */
document.addEventListener('click', function(event) {
  const element = event.target.closest('[data-explain]');
  if (element) {
    const text = element.getAttribute('data-explain');
    if (text) {
      speak(text);
      showToast(text);
    }
  }
});

/* =========================
   Lock behavior
   ========================= */
const lockCard = document.getElementById('lockCard');
const unlockInput = document.getElementById('unlockInput');
const unlockBtn = document.getElementById('unlockBtn');
const mainGrid = document.getElementById('mainGrid');

unlockBtn.addEventListener('click', function() {
  attemptUnlock(unlockInput.value.trim());
});

// Enter key support for password input
unlockInput.addEventListener('keypress', function(event) {
  if (event.key === 'Enter') {
    attemptUnlock(unlockInput.value.trim());
  }
});

function attemptUnlock(password) {
  if (!password) {
    speak("कृपया पासवर्ड भरें", 0.7);
    showToast("Password required");
    unlockInput.focus();
    return;
  }
  
  if (password === ADMIN_PASSWORD) {
    speak("स्वागत है, साइट खुल रही है। यह साइट विशेष लोगों के लिए है, आप यहाँ तक पहुँच गए हैं, आपका दिल से स्वागत है! सबसे पहले आपको एडमिन का संदेश मिलेगा, फिर आप मुझसे चैट कर सकते हैं। मैं हर सवाल का जवाब तो नहीं दे पाऊँगी, लेकिन आपके संदेश को एडमिन तक पहुँचाकर सही उत्तर दिलवा सकती हूँ।", 0.7);
    
    // Hide lock card and show main grid
    lockCard.style.display = 'none';
    mainGrid.style.display = 'block';
    
    // Show today's admin message
    displayDailyAdmin();
    
  } else {
    speak("गलत पासवर्ड, कृपया पुनः प्रयास करें", 0.7);
    showToast("Wrong password");
    unlockInput.value = '';
    unlockInput.focus();
    
    // Shake animation for wrong password
    lockCard.animate([
      { transform: 'translateX(-6px)' },
      { transform: 'translateX(6px)' },
      { transform: 'translateX(0)' }
    ], { duration: 380 });
  }
}

/* =========================
   Admin daily message logic (code-only)
   ========================= */
function getDailyAdminIndex() {
  const today = new Date();
  const year = today.getFullYear();
  const month = (today.getMonth() + 1).toString().padStart(2, '0');
  const day = today.getDate().toString().padStart(2, '0');
  const dateKey = `${year}-${month}-${day}`;
  
  // Check for override
  if (ADMIN_DATE_OVERRIDES[dateKey] !== undefined) {
    return ADMIN_DATE_OVERRIDES[dateKey] % ADMIN_MESSAGES.length;
  }
  
  // Deterministic rotation based on date
  const numeric = Number(`${year}${month}${day}`);
  return numeric % ADMIN_MESSAGES.length;
}

function displayDailyAdmin() {
  const index = getDailyAdminIndex();
  const message = ADMIN_MESSAGES[index] || "कोई संदेश उपलब्ध नहीं।";
  const messageElement = document.getElementById('adminMessage');
  const timeElement = document.getElementById('adminTime');
  
  // Replace \n with <br> for HTML display
  const formattedMessage = message.replace(/\n/g, '<br>');
  messageElement.innerHTML = formattedMessage;
  
  // Format current date and time
  const now = new Date();
  const options = { 
    day: 'numeric', 
    month: 'long', 
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  };
  timeElement.textContent = now.toLocaleString('hi-IN', options);
  
  // Speak admin message after a delay
  setTimeout(() => {
    speak("Admin संदेश: " + message, 0.7);
  }, 1500);
}

/* =========================
   Minimize toggles
   ========================= */
document.querySelectorAll('.minBtn').forEach(button => {
  button.addEventListener('click', function() {
    const panelType = this.getAttribute('data-toggle'); // admin, user, or media
    const panel = document.getElementById(panelType + 'Panel');
    
    if (panel.classList.contains('minimized')) {
      panel.classList.remove('minimized');
      this.textContent = '–';
    } else {
      panel.classList.add('minimized');
      this.textContent = '+';
    }
  });
});

/* =========================
   Chat: user messages (localStorage)
   ========================= */
const chatWindow = document.getElementById('chatWindow');
const userInput = document.getElementById('userInput');
const sendUser = document.getElementById('sendUser');
const savedArea = document.getElementById('savedArea');

function getUserMessages() {
  try {
    const messages = localStorage.getItem('priyanka_user_v2');
    return messages ? JSON.parse(messages) : [];
  } catch (error) {
    console.error("Error reading messages from localStorage:", error);
    return [];
  }
}

function saveUserMessages(messages) {
  try {
    localStorage.setItem('priyanka_user_v2', JSON.stringify(messages));
  } catch (error) {
    console.error("Error saving messages to localStorage:", error);
  }
}

function renderSavedMessages() {
  const messages = getUserMessages();
  
  if (messages.length === 0) {
    savedArea.innerHTML = "<div class='muted'>No saved messages.</div>";
    return;
  }
  
  const messagesHtml = messages.map(message => `
    <div style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px;">
      <div style="font-size:14px">${escapeHtml(message.text)}</div>
      <div class="muted">${message.time}</div>
    </div>
  `).join('');
  
  savedArea.innerHTML = messagesHtml;
}

function addChatMessage(sender, text) {
  const messageRow = document.createElement('div');
  messageRow.className = 'chatRow ' + (sender === 'user' ? 'user' : 'assistant');
  
  const bubble = document.createElement('div');
  bubble.className = 'bubble ' + (sender === 'user' ? 'user' : 'assistant');
  bubble.textContent = text;
  
  messageRow.appendChild(bubble);
  chatWindow.appendChild(messageRow);
  
  // Scroll to the bottom
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function assistantReply(userText) {
  const text = userText.toLowerCase();
  
  if (text.includes('hello') || text.includes('hi') || text.includes('namaste')) {
    return "हैलो! मैं आपकी कैसे मदद करूँ? ❤️";
  }
  
  if (text.includes('pyar') || text.includes('love') || text.includes('❤️') || text.includes('pyaar')) {
    return "आप बेहद खास हो — मैं हमेशा साथ हूँ ❤️";
  }
  
  if (text.includes('photo') || text.includes('picture') || text.includes('image')) {
    return "Media में photo URL डालकर Show photo दबाएँ।";
  }
  
  if (text.includes('video') || text.includes('movie') || text.includes('film')) {
    return "Media में video URL डालकर Play video दबाएँ।";
  }
  
  if (text.includes('thanks') || text.includes('thank you') || text.includes('dhanyavad') || text.includes('shukriya')) {
    return "आपका स्वागत है! हमेशा आपकी सेवा में ❤️";
  }
  
  if (text.includes('help') || text.includes('madad') || text.includes('sahayata')) {
    return "मैं आपकी कैसे मदद कर सकती हूँ? आप अपनी बात मुझे बताएं, मैं एडमिन तक पहुँचाने में मदद करूँगी।";
  }
  
  return "मैंने आपकी बात सुनी: \"" + userText + "\" — बताइए और क्या चाहिए?";
}

sendUser.addEventListener('click', function() {
  const message = userInput.value.trim();
  
  if (!message) {
    speak("कृपया संदेश लिखें", 0.7);
    showToast("Enter a message");
    userInput.focus();
    return;
  }
  
  // Add user message to chat
  addChatMessage('user', message);
  
  // Save message
  const messages = getUserMessages();
  const now = new Date();
  const timeString = now.toLocaleString('hi-IN', {
    day: 'numeric',
    month: 'short',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
  
  messages.push({
    text: message,
    time: timeString
  });
  
  saveUserMessages(messages);
  renderSavedMessages();
  
  // Get and display assistant reply
  const reply = assistantReply(message);
  
  setTimeout(() => {
    addChatMessage('assistant', reply);
    speak(reply, 0.7);
  }, 600);
  
  // Clear input and refocus
  userInput.value = '';
  userInput.focus();
});

// Enter key support for chat (but allow Shift+Enter for new line)
userInput.addEventListener('keypress', function(event) {
  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    sendUser.click();
  }
});

// Clear chat button
document.getElementById('clearChatBtn').addEventListener('click', function() {
  chatWindow.innerHTML = '';
  speak("Chat साफ़ हो गया", 0.7);
  showToast("Chat cleared");
});

// Download messages button
document.getElementById('downloadUser').addEventListener('click', function() {
  const messages = getUserMessages();
  const data = JSON.stringify(messages, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  
  const link = document.createElement('a');
  link.href = url;
  link.download = 'user-messages.json';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  URL.revokeObjectURL(url);
  
  speak("Saved messages डाउनलोड हो रहे हैं", 0.7);
  showToast("Messages downloaded");
});

// Show saved messages button
document.getElementById('showSavedBtn').addEventListener('click', function() {
  renderSavedMessages();
  speak("Saved messages दिखाए जा रहे हैं", 0.7);
  showToast("Saved messages shown");
});

// Initial render of saved messages
renderSavedMessages();

/* =========================
   Media loading
   ========================= */
const mediaPreview = document.getElementById('mediaPreview');

document.getElementById('loadMediaBtn').addEventListener('click', function() {
  const url = document.getElementById('mediaUrl').value.trim();
  
  if (!url) {
    speak("कृपया media url डालें", 0.7);
    showToast("Enter URL");
    return;
  }
  
  loadMedia(url);
});

function loadMedia(url) {
  // YouTube video
  if (url.includes('youtube.com') || url.includes('youtu.be')) {
    let videoId = '';
    
    if (url.includes('youtu.be/')) {
      videoId = url.split('youtu.be/')[1].split(/[?&]/)[0];
    } else if (url.includes('v=')) {
      videoId = url.split('v=')[1].split('&')[0];
    }
    
    if (videoId) {
      mediaPreview.innerHTML = `
        <iframe 
          width="100%" 
          height="260" 
          src="https://www.youtube.com/embed/${videoId}" 
          frameborder="0" 
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
          allowfullscreen>
        </iframe>
      `;
      speak("YouTube video लोड हो गया", 0.7);
      showToast("YouTube loaded");
      return;
    }
  }
  
  // Video files
  if (/\.mp4|\.webm|\.ogg/i.test(url)) {
    mediaPreview.innerHTML = `
      <video controls style="width:100%;max-height:320px;">
        <source src="${url}" type="video/mp4">
        Your browser does not support the video tag.
      </video>
    `;
    speak("Video लोड हो गया", 0.7);
    showToast("Video loaded");
    return;
  }
  
  // Audio files
  if (/\.mp3|\.wav|\.m4a|\.ogg|audio/i.test(url)) {
    mediaPreview.innerHTML = `
      <audio controls style="width:100%;">
        <source src="${url}" type="audio/mpeg">
        Your browser does not support the audio element.
      </audio>
    `;
    speak("Audio लोड हो गया", 0.7);
    showToast("Audio loaded");
    return;
  }
  
  // Image files
  if (/\.jpg|\.jpeg|\.png|\.gif|\.svg|\.webp/i.test(url)) {
    mediaPreview.innerHTML = `
      <img 
        src="${url}" 
        alt="Loaded media" 
        style="width:100%;height:auto;display:block;max-height:320px;border-radius:8px;"
        onerror="this.onerror=null;this.parentElement.innerHTML='<div class=\\'muted\\'>Failed to load image</div>';"
      >
    `;
    speak("Image लोड हो गया", 0.7);
    showToast("Image loaded");
    return;
  }
  
  // Default fallback
  mediaPreview.innerHTML = `
    <div style="padding:12px;text-align:center;">
      Preview not supported for this URL.<br>
      <a href="${url}" target="_blank" style="color:var(--accent3);text-decoration:none;">Open link in new tab</a>
    </div>
  `;
  speak("Link लोड हो गया, लेकिन preview उपलब्ध नहीं है", 0.7);
  showToast("Link loaded (no preview)");
}

// Media control buttons
document.getElementById('playAudioBtn').addEventListener('click', function() {
  const audio = mediaPreview.querySelector('audio');
  if (audio) {
    audio.play();
    speak("Audio चल रहा है", 0.7);
    showToast("Audio playing");
  } else {
    speak("No audio loaded to play", 0.7);
    showToast("No audio to play");
  }
});

document.getElementById('playVideoBtn').addEventListener('click', function() {
  const video = mediaPreview.querySelector('video');
  if (video) {
    video.play();
    speak("Video चल रहा है", 0.7);
    showToast("Video playing");
  } else {
    speak("No video loaded to play", 0.7);
    showToast("No video to play");
  }
});

document.getElementById('showPhotoBtn').addEventListener('click', function() {
  const image = mediaPreview.querySelector('img');
  if (image) {
    speak("Photo preview दिख रहा है", 0.7);
    showToast("Photo preview");
  } else {
    speak("No image loaded to show", 0.7);
    showToast("No image to show");
  }
});

/* Voice guide */
document.getElementById('voiceGuide').addEventListener('click', function() {
  const guide = "यह Priyanka assistant है। सबसे पहले लॉक खुलना चाहिए। Admin Message readonly है और हर दिन का संदेश दिखेगा। User Chat में message भेजें और ❤ दबाएँ। Media box में URL डालकर Load करें।";
  speak(guide, 0.7);
  showToast("Guide चलाया गया");
});

/* =========================
   Initialize the application
   ========================= */
document.addEventListener('DOMContentLoaded', function() {
  // Auto-focus on password input
  unlockInput.focus();
  
  // Initialize TTS voices if available
  if ('speechSynthesis' in window) {
    // Load voices
    setTimeout(function() {
      const voices = speechSynthesis.getVoices();
      if (voices.length > 0) {
        console.log("TTS voices loaded:", voices.length);
      }
    }, 500);
    
    // Some browsers need this to properly load voices
    speechSynthesis.getVoices();
  }
  
  // Welcome message (silent)
  console.log("Priyanka Assistant loaded. Please enter password to unlock.");
});
